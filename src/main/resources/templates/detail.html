<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${company.name} + ' - 기업 상세'">기업 상세</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 24px; }
        .card-header { background-color: #fff; border-bottom: 1px solid #eee; padding: 16px 20px; border-radius: 12px 12px 0 0 !important; }
        .section-title { font-size: 1.1rem; font-weight: 700; margin: 0; color: #495057; display: flex; align-items: center; gap: 8px; }

        /* 자동완성 검색 결과창 스타일 */
        #companyList {
            display: none; /* 기본 숨김 */
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .company-item { cursor: pointer; transition: background 0.2s; }
        .company-item:hover { background-color: #f1f3f5; }

        .chart-container { position: relative; height: 300px; width: 100%; }
        .table th { background-color: #f8f9fa; text-align: center; font-size: 0.9rem; }
        .table td { text-align: center; vertical-align: middle; }
    </style>
</head>
<body>

<div class="container py-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark" th:text="${company.name}">기업명</h2>
            <p class="text-muted mb-0">기업 성과 및 재무 데이터 상세 분석</p>
        </div>
        <a href="/" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 목록으로
        </a>
    </div>

    <div class="card border-primary border-opacity-25" style="background-color: #f0f7ff;">
        <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
                <h5 class="fw-bold text-primary mb-1"><i class="bi bi-bar-chart-line"></i> 비교 분석</h5>
                <p class="mb-0 text-secondary small">다른 기업을 검색하여 현재 기업과 데이터를 비교해보세요.</p>
            </div>

            <form method="get" action="/companies/compare" class="flex-grow-1" style="max-width: 500px;">
                <input type="hidden" name="base" th:value="${company.id}">
                <input type="hidden" id="targetCompanyId" name="target">

                <div class="position-relative">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-start-0" placeholder="비교할 기업명을 입력하세요 (예: 삼성전자)" autocomplete="off">
                        <button type="submit" class="btn btn-primary">비교하기</button>
                    </div>

                    <div id="companyList" class="list-group">
                        <div th:each="c : ${allCompanies}"
                             th:if="${c.id != company.id}"
                             class="list-group-item company-item border-start-0 border-end-0"
                             th:data-id="${c.id}"
                             th:text="${c.name}">
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="section-title"><i class="bi bi-globe-americas text-success"></i> ESG 점수 추이</h3>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="table-responsive h-100">
                        <table class="table table-hover table-bordered mb-0" id="scoreTable">
                            <thead class="table-light">
                            <tr><th>연도</th><th class="text-success">E</th><th class="text-primary">S</th><th class="text-warning">G</th></tr>
                            </thead>
                            <tbody>
                            <tr th:each="s : ${scores}">
                                <td class="fw-bold text-secondary" th:text="${s.year}"></td>
                                <td th:text="${s.eScore}"></td>
                                <td th:text="${s.sScore}"></td>
                                <td th:text="${s.gScore}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="chart-container">
                        <canvas id="esgChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="section-title"><i class="bi bi-graph-up-arrow text-danger"></i> 재무 지표 (매출 / 성장률)</h3>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="table-responsive h-100">
                        <table class="table table-hover table-bordered mb-0" id="finTable">
                            <thead class="table-light">
                            <tr><th>연도</th><th>매출</th><th>성장률(%)</th></tr>
                            </thead>
                            <tbody>
                            <tr th:each="f : ${financials}">
                                <td class="fw-bold text-secondary" th:text="${f.year}"></td>
                                <td th:text="${f.revenue}"></td>
                                <td th:class="${f.growthRate >= 0} ? 'text-danger fw-bold' : 'text-primary fw-bold'"
                                    th:text="${f.growthRate} + '%'"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="chart-container">
                        <canvas id="finChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const searchInput = document.getElementById("searchInput");
    const listBox = document.getElementById("companyList");
    const items = listBox.querySelectorAll(".company-item");
    const targetInput = document.getElementById("targetCompanyId");

    searchInput.addEventListener("input", () => {
        const keyword = searchInput.value.toLowerCase();
        let hasResult = false;

        items.forEach(item => {
            const name = item.textContent.toLowerCase();
            if (name.includes(keyword)) {
                item.style.display = "block";
                hasResult = true;
            } else {
                item.style.display = "none";
            }
        });

        listBox.style.display = (keyword.length > 0 && hasResult) ? "block" : "none";
    });

    searchInput.addEventListener("focus", () => {
        if(searchInput.value.trim().length > 0) listBox.style.display = "block";
    });

    document.addEventListener("click", (e) => {
        if (!searchInput.contains(e.target) && !listBox.contains(e.target)) {
            listBox.style.display = "none";
        }
    });

    items.forEach(item => {
        item.addEventListener("click", () => {
            searchInput.value = item.textContent.trim();
            targetInput.value = item.dataset.id;
            listBox.style.display = "none"; // 선택 후 닫기
        });
    });

    const years = [];
    const eArr = [], sArr = [], gArr = [];

    document.querySelectorAll('#scoreTable tbody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length >= 4) {
            years.push(tds[0].textContent.trim());
            eArr.push(parseFloat(tds[1].textContent.trim()));
            sArr.push(parseFloat(tds[2].textContent.trim()));
            gArr.push(parseFloat(tds[3].textContent.trim()));
        }
    });

    const esgCtx = document.getElementById('esgChart').getContext('2d');
    new Chart(esgCtx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [
                { label: 'E (Environment)', data: eArr, borderColor: '#198754', backgroundColor: '#198754', tension: 0.3 },
                { label: 'S (Social)', data: sArr, borderColor: '#0d6efd', backgroundColor: '#0d6efd', tension: 0.3 },
                { label: 'G (Governance)', data: gArr, borderColor: '#ffc107', backgroundColor: '#ffc107', tension: 0.3 },
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true } }
            },
            scales: {
                y: { suggestedMin: 0, suggestedMax: 100, grid: { color: '#f1f1f1' } },
                x: { grid: { display: false } }
            }
        }
    });

    const finYears = [];
    const revenueArr = [];
    const growthArr = [];

    document.querySelectorAll('#finTable tbody tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length >= 3) {
            finYears.push(tds[0].textContent.trim());
            const rev = parseFloat(tds[1].textContent.replace(/,/g, '').trim());
            const grText = tds[2].textContent.replace('%','').trim();
            const gr = parseFloat(grText);

            revenueArr.push(isNaN(rev) ? null : rev);
            growthArr.push(isNaN(gr) ? null : gr);
        }
    });

    const finCtx = document.getElementById('finChart').getContext('2d');
    new Chart(finCtx, {
        type: 'bar', // 매출은 막대가 더 보기 좋으므로 기본 bar
        data: {
            labels: finYears,
            datasets: [
                {
                    type: 'bar',
                    label: '매출 (Revenue)',
                    data: revenueArr,
                    yAxisID: 'y1',
                    backgroundColor: 'rgba(13, 110, 253, 0.6)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1
                },
                {
                    type: 'line',
                    label: '성장률 (Growth %)',
                    data: growthArr,
                    yAxisID: 'y2',
                    borderColor: '#dc3545',
                    backgroundColor: '#dc3545',
                    tension: 0.3,
                    pointStyle: 'circle',
                    pointRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top', labels: { usePointStyle: true } }
            },
            scales: {
                y1: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: '매출액' },
                    grid: { color: '#f1f1f1' }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    ticks: { callback: value => value + '%' },
                    title: { display: true, text: '성장률' }
                },
                x: { grid: { display: false } }
            }
        }
    });
</script>
</body>
</html>